// Using Arduino Hardware Serial (pins 0=RX, 1=TX)

// -------- Utility ----------
byte calcChecksum(byte *packet, int length) {
  int sum = 0;
  for (int i = 0; i < length - 1; i++) sum += packet[i];
  return (byte)(sum & 0xFF);  // lower 8 bits
}

void sendPacket(byte *packet, int length) {
  packet[length - 1] = calcChecksum(packet, length);
  Serial.write(packet, length);
}

// -------- Motor Commands ----------
void enableMotor(byte id) {
  byte packet[] = {id, 0x52, 0x70, 0x19, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00};
  sendPacket(packet, 10);
  Serial.print("Motor "); Serial.print(id); Serial.println(" ENABLED");
}

void disableMotor(byte id) {
  byte packet[] = {id, 0x52, 0x70, 0x19, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00};
  sendPacket(packet, 10);
  Serial.print("Motor "); Serial.print(id); Serial.println(" DISABLED");
}

void setSpeed(byte id, int rpm) {
  int16_t value = rpm;  
  byte hi = (value >> 8) & 0xFF;
  byte lo = value & 0xFF;

  byte packet[] = {id, 0x52, 0x70, 0xB1, 0x00, 0x00, 0x00, hi, lo, 0x00};
  sendPacket(packet, 10);

  Serial.print("Motor "); Serial.print(id);
  Serial.print(" speed set to "); Serial.print(rpm); Serial.println(" rpm");
}

// -------- Setup ----------
void setup() {
  Serial.begin(115200);  // UART to both motors
  delay(1000);

  Serial.println("Commands:");
  Serial.println(" le  -> Enable left (ID=1)");
  Serial.println(" lo  -> Disable left");
  Serial.println(" re  -> Enable right (ID=2)");
  Serial.println(" ro  -> Disable right");
  Serial.println(" l200 -> Left motor 200 rpm");
  Serial.println(" r-150 -> Right motor -150 rpm");
  Serial.println(" b100 -> Both motors 100 rpm");
}

// -------- Loop ----------
String inputString = "";

void loop() {
  while (Serial.available()) {
    char c = Serial.read();

    if (c == '\n' || c == '\r') {
      if (inputString.length() > 0) {
        if (inputString == "le") enableMotor(0x01);
        else if (inputString == "lo") disableMotor(0x01);
        else if (inputString == "re") enableMotor(0x02);
        else if (inputString == "ro") disableMotor(0x02);
        else if (inputString.startsWith("l")) {
          int rpm = inputString.substring(1).toInt();
          setSpeed(0x01, rpm);
        } 
        else if (inputString.startsWith("r")) {
          int rpm = inputString.substring(1).toInt();
          setSpeed(0x02, rpm);
        }
        else if (inputString.startsWith("b")) {
          int rpm = inputString.substring(1).toInt();
          setSpeed(0x01, rpm);
          setSpeed(0x02, rpm);
        }
        inputString = "";
      }
    } else {
      inputString += c;
    }
  }
}
